---
title: "pacific_herring"
author: "laura e timm"
date: '2024-01-25'
output: html_document
---

# setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## load libraries
```{r load_libraries, warning=FALSE, message=FALSE}

#install.packages("rgdal", type="source")
#install.packages("remotes")
#remotes::install_github("royfrancis/pophelper")

packages_needed <- c("tidyverse", "ggplot2", "readxl",
                     "ggOceanMaps", "pophelper", "stringr",
                     "ggspatial", "gridExtra", "ggpubr")

# packages_needed <- c("dplyr", "tidyverse", "ggplot2",
#                      "readxl", "RColorBrewer", "ggpubr",
#                      "stats", "scales", "rgdal", "ggmap",
#                      "ggOceanMaps", "pophelper",
#                       "label.switching", "remotes",
#                      "stringr", "writexl", "ggpmisc",
#                      "dismo", "maps", "mapdata",
#                      "adegenet", "poppr", "hierfstat",
#                      "vcfR", "ape", "pegas")

for(i in 1:length(packages_needed)){
  if(!(packages_needed[i] %in% installed.packages())){install.packages(packages_needed[i])}
  library(packages_needed[i], character.only = TRUE)
}

```


## define functions

### plot pca
```{r plot_pca_fx}

plot_pca <- function(FEATURE_DF, COV_MATRIX) {
  pca_e <- eigen(COV_MATRIX)
  first3pcs <- data.frame(pca_e$vectors[,1:3])
  labeled_first3pcs <- cbind(FEATURE_DF,
                             pc1 = first3pcs$X1,
                             pc2 = first3pcs$X2,
                             pc3 = first3pcs$X3)
  pca_graph <- ggplot(labeled_first3pcs, aes(x = pc1, y = pc2, color = feature, shape = spawning)) + 
    geom_point(size = 3) +
    scale_color_manual(values=opt1_region_palette) +
    xlab(paste0("PC1 - ", sprintf("%0.2f", pca_e$values[1]), "%")) +
    ylab(paste0("PC2 - ", sprintf("%0.2f", pca_e$values[2]), "%"))
}

```

### find optimal k for admixture analysis
```{r optimal_k_fx}

opt_k_fx <- function(LOG_FILENAMES, K_VAL) {
  bigData<-lapply(1:length(LOG_FILENAMES), FUN = function(i) readLines(LOG_FILENAMES[i]))
  foundset<-sapply(1:length(LOG_FILENAMES), FUN= function(x) bigData[[x]][which(str_sub(bigData[[x]], 1, 1) == 'b')])
  as.numeric( sub("\\D*(\\d+).*", "\\1", foundset) )
  logs<-data.frame(K = rep(1:K_VAL, each=3))
  logs$like<-as.vector(as.numeric( sub("\\D*(\\d+).*", "\\1", foundset) ))
  tapply(logs$like, logs$K, FUN= function(x) mean(abs(x))/sd(abs(x)))
}
  
```

### plot admixture
```{r define_admixplot_fx}

admix_plot <- function(FEAT_DF, qopt_files, OUT_DIR, OUT_NAME) {
  groupings <- data.frame(FEAT_DF$ordered_region)
  admix_list <- readQ(qopt_files)
  k_list <- c()
  for (i in 2:length(admix_list)) {
    k_list <- c(k_list, paste0("k = ", as.character(i)))
  }
  
  p1 <- plotQ(alignK(admix_list[2:3]),
            grplab = groupings,
            #selgrp = "region",
            #subsetgrp = ordered_regions,
            grplabangle = 45,
            grplabpos = 0.6,
            grplabheight = 2,
            grplabjust = 1,
            panelratio = c(2,2),
            grplabsize = 8,
            splab = k_list[1:2],
            splabsize =18,
            ordergrp = T,
            clustercol = c("#416044","#31395a","#b0c7a2","#7580aa"),
            #showdiv = T,
            #divgrp = "region",
            imgoutput = "join",
            returnplot = T,
            exportplot = T,
            basesize = 11,
            sortind = "Cluster1",
            sharedindlab = F,
            imgtype = "jpeg",
            width = 20,
            height = 4,
            units = "in",
            dpi = 600,
            exportpath = OUT_DIR,
            outputfilename = OUT_NAME)
  grid.arrange(p1$plot[[1]])
}

```


## specify
```{r project_setup}

BASEDIR <- "C:/Users/laura.timm/Desktop/Clupea_pallasii/" #the directory where the metadata file lives
FIG_DIR <- paste0(BASEDIR, "FIGURES/")
PREFIX <- "CPAL-CHARFULL" #the prefix for the lcWGS run
METADATAFILE <- paste0(BASEDIR, "pacific-herring_metadataUSEME.xlsx") #metadatafile name (excel file)
SHEET <- "Sheet1" #sheet containing the pertinent metadata
DEPTH_LOWER_BOUND <- 1
ADMIX_PREFIX_all <- "admixture/CPAL-CHARFULL_wgph"

CHROMFILE <- paste0(BASEDIR, "CHAR_chrom_metadata.txt")
chrom_df <- read.table(CHROMFILE, header = TRUE)

metadata <- read_xlsx(METADATAFILE, sheet = SHEET)

#palette
orig_region_clust_palette <- c(Togiak = "#313695",
                               eBS1 = "#4575B4",
                               eBS2 = "#ABD9E9",
                               Cordova = "#A50026",
                               GOA1 = "#F46D43",
                               GOA2 ="#FDAE61",
                               Kodiak_Outside_Kiliuda = "#588b8b",
                               ConstantineBay = "#ffd5c2",
                               Kodiak_Inside_Uganik = "#93b7be",
                               PortMoller = "#c8553d",
                               PopofIsland = "#386641",
                               Unalakleet = "#6a3d9a",
                               NelsonIsland = "#b2df8a",
                               GoodnewsBay = "#775954",
                               KangirlvarBay = "#FFE078")
#teal and orange
opt1_region_palette <- c("Togiak" = "#2a5674",
                         "Port Moller" = "#4f90a6",
                         "Constantine Bay" = "#85c4c9",
                         "Popof Island" = "#fdd0a2",
                         "Kodiak - Kiliuda" = "#fd8d3c",
                         "Kodiak - Uganik" = "#d94801",
                         "Cordova" = "#8c2d04")

#turquoise and red
opt2_region_palette <- c(Togiak = "#1d5167",
                         PortMoller = "#437f79",
                         ConstantineBay = "#7aab92",
                         PopofIsland = "#fcbba1",
                         Kodiak_Outside_Kiliuda = "#fc9272",
                         Kodiak_Inside_Uganik = "#ef3b2c",
                         Cordova = "#99000d")

#purple and 
opt3_region_palette <- c(Togiak = "#6a51a3",
                         PortMoller = "#807dba",
                         ConstantineBay = "#9e9ac8",
                         PopofIsland = "#fdd0a2",
                         Kodiak_Outside_Kiliuda = "#fd8d3c",
                         Kodiak_Inside_Uganik = "#d94801",
                         Cordova = "#8c2d04")

```


# all samples (eBS + GOA)

## Mapping collection locations

```{r map_samples}

specimen_samples <- count(metadata, Latitude_DD, Longitude_DD, MarineRegion, spawning)

#incoming samples
#specimen_samples[8,]=list(63.8703,-160.7859,"Unalakleet",20)
#specimen_samples[9,]=list(59.04,-161.80,"GoodnewsBay",20)
#specimen_samples[10,]=list(60.48,-165.21,"KangirlvarBay",20)
#specimen_samples[11,]=list(60.4360,-165.2220,"NelsonIsland",20)
#specimen_samples$batch <- c(rep.int("in-hand",7), rep.int("incoming",4))

##from Jessica
#herring savings areas
#summer area 1
#hs1 <- data.frame(lon = c(-164,-164,-162,-162), lat = c(55, 57, 57, 55))
#summer area 2
#hs2 <- data.frame(lon = c(-167,-167,-164,-164), lat = c(54,56.3,56.3, 54))
#winter savings area
#hs3 <- data.frame(lon = c(-175,-175,-172,-172), lat = c(58, 60, 60, 58))

(m <- basemap(limits = c(-167, -145, 53, 61), bathymetry = T, rotate = T) +
    geom_spatial_point(data = specimen_samples,
                       size = 3,
                       aes(x = Longitude_DD, 
                           y = Latitude_DD,
                           shape = spawning,
                           color = MarineRegion)) +
    scale_color_manual(values=opt1_region_palette) +
    #geom_spatial_polygon(data = hs1, aes(x = lon, y = lat), fill = NA, color = "red") +
    #geom_spatial_polygon(data = hs2, aes(x = lon, y = lat), fill = NA, color = "red") +
    #geom_spatial_polygon(data = hs3, aes(x = lon, y = lat), fill = NA, color = "red") +
    annotation_scale() + #scale bar
    annotation_north_arrow(location = "tr", which_north = "true")) #north arrow

#ggsave(paste0(FIG_DIR, PREFIX, "color-opt1_size3_map.pdf"), width = 6, height = 7, units = "in", dpi = 600)

```



## Aligned sequencing depths

```{r plot_initial_depth_distributions, warning=FALSE, message=FALSE}

just_depths <- read.csv(paste0(BASEDIR, PREFIX, "_depths.csv"), header = FALSE, sep = '\t')
colnames(just_depths) <- c("Barcode", "mean_depth")
full_metadata <- left_join(metadata, just_depths, by = "Barcode")

theme_set(
  theme( 
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 90, size = 10, vjust = 0.5),
    axis.text.y = element_text(angle = 0, size = 10),
    panel.background = element_rect(fill = "white"), 
    panel.spacing = unit(0,"lines"),
    strip.text.y = element_text(angle = 0) 
  )
)

(depths_dists_plot <- ggplot(full_metadata, aes(x = mean_depth, color = MarineRegion)) +
    geom_density(n = 50, linewidth = 1) +
    geom_vline(aes(xintercept = DEPTH_LOWER_BOUND), colour = "black") +
    scale_color_manual(values=opt1_region_palette) +
    ggtitle("individual mean sequence depth distributions"))

#ggsave(paste0(BASEDIR, PREFIX, "_region_mean_depths.jpg"), width = 8, height = 5, units = "in", dpi = 300)

```

## PCA

```{r pca_all}

covfile_all <- as.matrix(read.table(paste0(BASEDIR, "pca/", PREFIX, "_wgph.cov")))
features_df_all <- metadata[c("Barcode", "MarineRegion", "spawning")]
colnames(features_df_all) <- c("Barcode", "feature", "spawning")

(pca_all <- plot_pca(features_df_all, covfile_all))

#ggsave(paste0(FIG_DIR, PREFIX, "_PCA_color-opt1_size3.jpg"), width = 6, height = 4, units = "in", dpi = 600)

```


### PCA by region
```{r pca_grid_spawn_region, fig.width = 8, fig.heigth = 20}

pca_e_facet <- eigen(covfile_all)
first3pcs_facet <- data.frame(pca_e_facet$vectors[,1:3])
labeled_first3pcs_facet <- cbind(metadata,
                           pc1 = first3pcs_facet$X1,
                           pc2 = first3pcs_facet$X2,
                           pc3 = first3pcs_facet$X3)
(pca_facet <- ggplot(labeled_first3pcs_facet, aes(x = pc1, y = pc2, color = MarineRegion, shape = spawning)) + 
  geom_point(size = 3, alpha = 0.75) +
  scale_color_manual(values=opt1_region_palette) +
  xlab(paste0("PC1 - ", sprintf("%0.2f", pca_e_facet$values[1]), "%")) +
  ylab(paste0("PC2 - ", sprintf("%0.2f", pca_e_facet$values[2]), "%")) +
  facet_grid(rows = vars(MarineRegion)))

#ggsave(paste0(FIG_DIR, PREFIX, "_PCA_region_facet_color-opt1_size3.jpg"), width = 8, height = 12, units = "in", dpi = 600)

```



## Admixture
```{r opt_k_all}

LOGS_all <- Sys.glob(paste0(BASEDIR, ADMIX_PREFIX_all, "*.log"))
opt_k_fx(LOGS_all, 7)

```



```{r admix_plot_all}

QOPTS_all <- Sys.glob(paste0(BASEDIR, ADMIX_PREFIX_all, "_*-2.qopt"))
#oname <- paste0(PREFIX, "_K23-admix_by-clust_TOG2COR")
#features_df_admix <- metadata[c("Barcode", "admix_grp_order_TOG2COR")]
oname <- paste0(PREFIX, "_K23-admix_by-clust_COR2TOG")
features_df_admix <- metadata[c("Barcode", "admix_grp_order_COR2TOG")]
colnames(features_df_admix) <- c("Barcode", "ordered_region")
(all_samples_admix_plot <- admix_plot(features_df_admix, QOPTS_all, FIG_DIR, oname))

```



Let's start considering these two clusters (eBS and GOA as separate groups):
"eBS" = eBS, Constantine Bay, and Port Moller
"GOA" = GOA, Kodiak, and Popof

# eBS

## PCA

### N = 60
```{r pca_eBS}

eBS_metadata <- metadata %>%
  filter(twopops_nuc_cluster == "eBSAI")
features_df_eBS <- eBS_metadata[c("Barcode", "MarineRegion", "spawning")]
colnames(features_df_eBS) <- c("Barcode", "feature", "spawning")

covfile_eBS <- as.matrix(read.table(paste0(BASEDIR, "pca/", PREFIX, "-eBS_wgph.cov")))

(pca_eBS <- plot_pca(features_df_eBS, covfile_eBS))

#ggsave(paste0(BASEDIR, PREFIX, "-eBS_PCA_region.jpg"), width = 6, height = 4, units = "in", dpi = 600)

```



Maybe two or three groups? Remove outliers to see it better.

### N = 59

```{r pca_eBS_59}

#identify which individuals to filter out
pca_e_eBS <- eigen(covfile_eBS)
first3pcs_eBS <- data.frame(pca_e_eBS$vectors[,1:3])
labeled_first3pcs_eBS <- cbind(features_df_eBS,
                             pc1 = first3pcs_eBS$X1,
                             pc2 = first3pcs_eBS$X2,
                             pc3 = first3pcs_eBS$X3)
(filter_eBS_59 <- labeled_first3pcs_eBS[labeled_first3pcs_eBS$pc1 > 0.6,])

eBS_metadata_59 <- labeled_first3pcs_eBS[labeled_first3pcs_eBS$pc1 < 0.6,]
features_df_eBS_59 <- eBS_metadata_59[c("Barcode", "feature", "spawning")]

covfile_eBS_59 <- as.matrix(read.table(paste0(BASEDIR, "pca/", PREFIX, "-eBS_wgph_keep59.cov")))

(pca_eBS_59 <- plot_pca(features_df_eBS_59, covfile_eBS_59))

#ggsave(paste0(BASEDIR, PREFIX, "-eBS59_PCA_region_color-opt1.jpg"), width = 5.5, height = 4, units = "in", dpi = 600)

```


Let's assign individuals to clusters for manhattan plots!
```{r eBS59_classification}

pca_e_eBS59 <- eigen(covfile_eBS_59)
first3pcs_eBS59 <- data.frame(pca_e_eBS59$vectors[,1:3])
labeled_first3pcs_eBS59 <- cbind(features_df_eBS_59,
                             pc1 = first3pcs_eBS59$X1,
                             pc2 = first3pcs_eBS59$X2,
                             pc3 = first3pcs_eBS59$X3)

#upper lefthand cluster
eBS59A <- labeled_first3pcs_eBS59 %>%
  filter(pc1 < 0.0 & pc2 > 0.0)
#lower lefthand cluster
eBS59B <- labeled_first3pcs_eBS59 %>%
  filter(pc1 < 0.0 & pc2 < 0.0)
#righthand cluster
eBS59C <- labeled_first3pcs_eBS59 %>%
  filter(pc1 > 0.15 & pc1 <0.3 & pc2 < 0.1)

```

Yes, structure, but NOT related to geography of spawning pops (Togiak and Port Moller).


# Gulf of Alaska

## PCA

### N = 60
```{r pca_GOA}

GOA_metadata <- metadata %>%
  filter(twopops_nuc_cluster == "nGOA")

features_df_GOA <- GOA_metadata[c("Barcode", "MarineRegion", "spawning")]

colnames(features_df_GOA) <- c("Barcode", "feature", "spawning")

covfile_GOA <- as.matrix(read.table(paste0(BASEDIR, "pca/", PREFIX, "-GOA_wgph.cov")))

(pca_GOA <- plot_pca(features_df_GOA, covfile_GOA))

#ggsave(paste0(BASEDIR, PREFIX, "-GOA_PCA_region_color-op1.jpg"), width = 6, height = 4, units = "in", dpi = 600)

```

Popof Island might be disguising underlying structure. Let's remove Popof and try GOA40

### N = 40

```{r pca_GOA_noPopof}

features_df_GOA_noPopof <- features_df_GOA %>%
  filter(feature != "Popof Island")

covfile_GOA_noPopof <- as.matrix(read.table(paste0(BASEDIR, "pca/", PREFIX, "-GOA-noPopof_wgph.cov")))

(pca_GOA_noPopof <- plot_pca(features_df_GOA_noPopof, covfile_GOA_noPopof))

#need to change the plot_pca fx to shape = 17 in geom_point

#ggsave(paste0(BASEDIR, PREFIX, "-GOA-noPopof_PCA_region_color-opt1.jpg"), width = 6, height = 4, units = "in", dpi = 600)

```

For the pub:
```{r pca_ggarrange}

(pca_fig <- ggarrange(pca_all, pca_eBS_59, pca_GOA, pca_GOA_noPopof, ncol = 2, nrow = 2, common.legend=TRUE))
ggsave(paste0(FIG_DIR, "PCA_FIGURE.jpg"), width = 8, height = 8, units = "in", dpi = 600)

```


Let's move forward with GOA with Popof
